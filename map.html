<!DOCTYPE html>
<html>
  <head>
    <title>CT Scan Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
      #plot {
        width: 50%;
        float: left;
      }

      #map {
        width: 50%;
        height: 400px;
        float: right;
      }

      #card1,
      #card2 {
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 20px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>CT Scan Dashboard</h1>
    <div id="plot"></div>
    <div id="map"></div>
    <div id="card1"></div>
    <div id="card2"></div>
    <script>
      Plotly.d3.csv("data/scan_data.csv", function (err, scanRows) {
        Plotly.d3.csv("data/hospital_data.csv", function (err, hospitalRows) {
          function unpack(rows, key) {
            return rows.map(function (row) {
              return row[key];
            });
          }

          var years = unpack(scanRows, "Year");
          var waitingTimes = unpack(scanRows, "Avg Waiting Time (in Days)");

          var trace = {
            x: years,
            y: waitingTimes,
            mode: "markers+lines",
            type: "scatter",
            marker: { symbol: "circle", size: 6 },
          };

          var layout = {
            xaxis: { title: "Year" },
            yaxis: { title: "Avg Waiting Time (in Days)" },
            title: "Average Waiting Time for CT Scans over the Years",
          };

          var data = [trace];
          Plotly.newPlot("plot", data, layout);

          var map = L.map("map").setView([47.5, 19.0], 7);

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors",
          }).addTo(map);

          var hospitalIcon = L.icon({
            iconUrl: "hospital-icon.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32],
          });

          for (var i = 1; i < hospitalRows.length; i++) {
            var row = hospitalRows[i];
            var hospitalName = row["Hospital Name"];
            var address = row["Address"];
            var latLng = [
              parseFloat(row["Latitude"]),
              parseFloat(row["Longitude"]),
            ];

            L.marker(latLng, { icon: hospitalIcon })
              .bindPopup("<b>" + hospitalName + "</b><br>" + address)
              .addTo(map);
          }

          var card1 = document.getElementById("card1");
          var card2 = document.getElementById("card2");

          function displayValue(value, card) {
            card.innerHTML = "Value: " + value;
          }

          function clearCards() {
            card1.innerHTML = "Click on the graph to display a value.";
            card2.innerHTML = "Click on a hospital to display its data.";
          }

          // Add event listener to the graph
          var plot = document.getElementById("plot");
          plot.on("plotly_click", function (data) {
            var pointData = data.points[0];
            var year = pointData.x;
            var waitingTime = pointData.y;
            displayValue(waitingTime, card1);
          });

          // Add event listener to the map markers
          var markers = document.getElementsByClassName("leaflet-marker-icon");
          for (var j = 0; j < markers.length; j++) {
            markers[j].addEventListener("click", function (e) {
              var popupContent = e.target._popup._content;
              var hospitalName = popupContent
                .split("<br>")[0]
                .replace("<b>", "")
                .replace("</b>", "");
              var hospitalData = hospitalRows.find(function (row) {
                return row["Hospital Name"] === hospitalName;
              });
              var yearlyTotal = hospitalData["Yearly Total Paitent"];
              displayValue(yearlyTotal, card2);
            });
          }

          // Initialize the cards
          clearCards();
        });
      });
    </script>
  </body>
</html>
